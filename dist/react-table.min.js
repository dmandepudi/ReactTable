/*! react-table 30-10-2014 Author: Erfang Chen */
function groupData(data,groupBy,columnDefs){var bucketResults=buildDataBuckets(data,groupBy),aggregationResults=aggregateBuckets(bucketResults,columnDefs);return aggregationResults.concat(data)}function straightSumAggregation(options){for(var data=options.data,columnDef=options.columnDef,result=0,i=0;i<data.length;i++)result+=data[i][columnDef.colTag];return result}function average(options){return options.columnDef.weightBy?weightedAverage(options):simpleAverage(options)}function simpleAverage(options){return straightSumAggregation(options)/options.data.length}function weightedAverage(options){for(var data=options.data,columnDef=options.columnDef,weightBy=options.columnDef.weightBy,sumProduct=0,i=0;i<data.length;i++)sumProduct+=data[i][columnDef.colTag]*data[i][weightBy.colTag];var weightSum=straightSumAggregation({data:data,columnDef:weightBy});return sumProduct/weightSum}function count(options){options.data,options.columnDef}function countDistinct(options){options.data,options.columnDef}function extractSectors(row,groupBy){for(var results=[],i=0;i<groupBy.length;i++)results.push(row[groupBy[i].colTag]);return results}function buildDataBuckets(data,groupBy){for(var results={},i=0;i<data.length;i++){var sectorPath=extractSectors(data[i],groupBy);data[i].sectorPath=sectorPath,data[i].isDetail=!0;for(var j=0;j<sectorPath.length;j++){var subSectorPath=sectorPath.slice(0,j+1),subSectorKey=generateSectorKey(subSectorPath);results[subSectorKey]||(results[subSectorKey]={data:[],sectorPath:subSectorPath}),results[subSectorKey].data.push(data[i])}}return results}function aggregateBuckets(bucketResults,columnDefs){var result=[];for(var sectorKey in bucketResults)if(bucketResults.hasOwnProperty(sectorKey)){var singleSectorResult=aggregateSector(bucketResults[sectorKey],columnDefs);result.push(singleSectorResult)}return result}function aggregateSector(bucketResult,columnDefs){var result={};result.sectorPath=bucketResult.sectorPath,result[columnDefs[0].colTag]=bucketResult.sectorPath[bucketResult.sectorPath.length-1];for(var i=1;i<columnDefs.length;i++)result[columnDefs[i].colTag]=aggregateColumn(bucketResult,columnDefs[i]);return result}function aggregateColumn(bucketResult,columnDef){var result;switch(columnDef.aggregationMethod){case"SUM":result=straightSumAggregation({data:bucketResult.data,columnDef:columnDef});break;case"AVERAGE":result=average({data:bucketResult.data,columnDef:columnDef});break;default:result=""}return result}function buildHeaders(table){var headerColumns=table.state.columnDefs.map(function(columnDef){var styles={"text-align":"number"==columnDef.format?"right":"left"};return React.DOM.th({style:styles,key:columnDef.colTag},React.DOM.a({className:"btn-link",onClick:table.handleSort.bind(table,columnDef)},columnDef.text),React.DOM.a({className:"btn-link",onClick:table.handleRemove.bind(table,columnDef)},React.DOM.span({className:"pull-right glyphicon glyphicon-remove"})))});return headerColumns.push(React.DOM.th({style:{"text-align":"center"}},React.DOM.a({onClick:table.handleAdd},React.DOM.span({className:"glyphicon glyphicon-plus"})))),React.DOM.thead(null,React.DOM.tr(null,headerColumns))}function buildFirstCellForRow(props){var result,data=props.data,columnDef=props.columnDefs[0],toggleHide=props.toggleHide,firstColTag=columnDef.colTag;if(!data.sectorPath)return React.DOM.td({key:data[firstColTag]},data[firstColTag]);var identLevel=data.isDetail?data.sectorPath.length:data.sectorPath.length-1,firstCellStyle={"padding-left":25*identLevel+"px","border-right":"1px #ddd solid"};return result=data.isDetail?React.DOM.td({style:firstCellStyle,key:data[firstColTag]},data[firstColTag]):React.DOM.td({style:firstCellStyle,key:data[firstColTag]},React.DOM.a({onClick:toggleHide.bind(null,data),className:"btn-link"},React.DOM.strong(null,data[firstColTag])))}function buildFooter(){return null}function shouldHide(data,collapsedSectorPaths){var result=!1,hasCollapsedAncestor=areAncestorsCollapsed(data.sectorPath,collapsedSectorPaths),isSummaryRow=!data.isDetail,immediateSectorCollapsed=null!=collapsedSectorPaths[generateSectorKey(data.sectorPath)];return hasCollapsedAncestor?result=!0:immediateSectorCollapsed&&!isSummaryRow&&(result=!0),result}function areAncestorsCollapsed(sectorPath,collapsedSectorPaths){var result=!1;for(var sectorPathKey in collapsedSectorPaths)collapsedSectorPaths.hasOwnProperty(sectorPathKey)&&isSubSectorOf(sectorPath,collapsedSectorPaths[sectorPathKey])&&(result=!0);return result}function isSubSectorOf(subSectorCandidate,superSectorCandidate){if(subSectorCandidate.length<=superSectorCandidate.length)return!1;for(var i=0;i<superSectorCandidate.length;i++)if(subSectorCandidate[i]!=superSectorCandidate[i])return!1;return!0}function generateRowKey(row,rowKey){var key;if(rowKey)key=row[rowKey];else{key=generateSectorKey(row.sectorPath);for(var prop in row)row.hasOwnProperty(prop)&&(key+=prop+"="+row[prop]+";")}return key}function generateSectorKey(sectorPath){return sectorPath?sectorPath.join(SECTOR_SEPARATOR):""}function prepareTableData(props){var data=deepCopyData(props.data);if(props.groupBy){data=groupData(data,props.groupBy,props.columnDefs);var sortOptions={sectorSorter:defaultSectorSorter,detailSorter:defaultDetailSorter};data.sort(sorterFactory.call(this,sortOptions))}return data}function deepCopyData(data){return data.map(function(row){var copy={};for(var prop in row)row.hasOwnProperty(prop)&&(copy[prop]=row[prop]);return copy.isDetail=!0,copy})}function getInitiallyCollapsedSectorPaths(data){var result={};return data.map(function(row){if(row.sectorPath&&row.isDetail){var sectorPathKey=generateSectorKey(row.sectorPath);result[sectorPathKey]||(result[sectorPathKey]=row.sectorPath)}}),result}function getInitiallySelectedRows(selectedRows){var result={};selectedRows=selectedRows||[];for(var i=0;i<selectedRows.length;i++)result[selectedRows[i]]=1;return result}function ReactTableHandleSort(columnDefToSortBy){var data=this.state.data,sortOptions={sectorSorter:defaultSectorSorter,detailSorter:getSortFunction(columnDefToSortBy),sortDetailBy:columnDefToSortBy};data.sort(sorterFactory.call(this,sortOptions)),columnDefToSortBy.asc=!columnDefToSortBy.asc,this.setState({data:data})}function ReactTableHandleAdd(){this.props.beforeColumnAdd&&this.props.beforeColumnAdd()}function ReactTableHandleRemove(columnDefToRemove){for(var loc=this.state.columnDefs.indexOf(columnDefToRemove),newColumnDefs=[],i=0;i<this.state.columnDefs.length;i++)i!=loc&&newColumnDefs.push(this.state.columnDefs[i]);this.setState({columnDefs:newColumnDefs}),null!=this.props.afterColumnRemove&&this.props.afterColumnRemove(newColumnDefs,columnDefToRemove)}function ReactTableHandleToggleHide(summaryRow){var sectorKey=generateSectorKey(summaryRow.sectorPath);null==this.state.collapsedSectorPaths[sectorKey]?this.state.collapsedSectorPaths[sectorKey]=summaryRow.sectorPath:delete this.state.collapsedSectorPaths[sectorKey],this.setState({collapsedSectorPaths:this.state.collapsedSectorPaths})}function ReactTableHandleRowSelect(row){var rowKey=this.props.rowKey;if(rowKey&&row.isDetail){this.props.onSelectCallback&&this.props.onSelectCallback.call(this,row);var selectedRows=this.state.selectedRows;selectedRows[row[rowKey]]?delete selectedRows[row[rowKey]]:selectedRows[row[rowKey]]=1,this.setState({selectedRows:selectedRows})}}function sorterFactory(options){var sectorSorter=options.sectorSorter,detailSorter=options.detailSorter,sortSummaryBy=options.sortSummaryBy,sortDetailBy=options.sortDetailBy;return function(a,b){var result=0;return result=sectorSorter.call(sortSummaryBy,a,b),0==result&&(result=a.isDetail&&!b.isDetail?1:b.isDetail&&!a.isDetail?-1:0,0==result&&(result=detailSorter.call(sortDetailBy,a,b))),result}.bind(this)}function defaultSectorSorter(a,b){return generateSectorKey(a.sectorPath).localeCompare(generateSectorKey(b.sectorPath))}function defaultDetailSorter(a,b){return generateRowKey(a).localeCompare(generateRowKey(b))}function genericDetailSort(a,b){var returnValue=0;return a[this.colTag]<b[this.colTag]?returnValue=-1:a[this.colTag]>b[this.colTag]&&(returnValue=1),this.asc&&(returnValue*=-1),returnValue}function dateDetailSort(a,b){var returnValue=new Date(a[this.colTag])-new Date(b[this.colTag]);return this.asc&&(returnValue*=-1),returnValue}function getSortFunction(sortBy){var format=sortBy.format||"";switch(format.toUpperCase()){case"DATE":return dateDetailSort;default:return genericDetailSort}}var SECTOR_SEPARATOR="#",ReactTable=React.createClass({displayName:"ReactTable",getInitialState:function(){var data=prepareTableData.call(this,this.props),collapsedSectorPaths=getInitiallyCollapsedSectorPaths(data),selectedRows=getInitiallySelectedRows(this.props.selectedRows);return{data:data,columnDefs:this.props.columnDefs,collapsedSectorPaths:collapsedSectorPaths,selectedRows:selectedRows}},handleSort:ReactTableHandleSort,handleAdd:ReactTableHandleAdd,handleRemove:ReactTableHandleRemove,handleToggleHide:ReactTableHandleToggleHide,handleRowSelect:ReactTableHandleRowSelect,render:function(){for(var unhiddenRows=[],i=0;i<this.state.data.length;i++){var row=this.state.data[i];shouldHide(row,this.state.collapsedSectorPaths)||unhiddenRows.push(row)}var rows=unhiddenRows.map(function(row){var rowKey=this.props.rowKey;return Row({data:row,key:generateRowKey(row,rowKey),isSelected:rowKey&&this.state.selectedRows[row[rowKey]]?!0:!1,onSelect:this.handleRowSelect,columnDefs:this.state.columnDefs,toggleHide:this.handleToggleHide})},this),headers=buildHeaders(this),footer=buildFooter(this);return React.DOM.div(null,React.DOM.table({className:"table table-condensed"},headers,React.DOM.tbody(null,rows)),footer)}}),Row=React.createClass({displayName:"Row",render:function(){for(var cells=[buildFirstCellForRow(this.props)],i=1;i<this.props.columnDefs.length;i++){var columnDef=this.props.columnDefs[i],style={"text-align":"number"==columnDef.format?"right":"left"},cellContent=this.props.data[columnDef.colTag];cells.push(React.DOM.td({style:style,key:columnDef.colTag+"="+this.props.data[columnDef.colTag]},cellContent))}var styles={cursor:this.props.data.isDetail?"pointer":"inherit","background-color":this.props.isSelected&&this.props.data.isDetail?"#999999":"inherit",color:this.props.isSelected&&this.props.data.isDetail?"#ffffff":"inherit"};return React.DOM.tr({onClick:this.props.onSelect.bind(null,this.props.data),style:styles},cells)}}),PageNavigator=React.createClass({displayName:"PageNavigator",render:function(){var self=this,cx=React.addons.classSet,prevClass=cx({disabled:1==this.props.activeItem}),nextClass=cx({disabled:this.props.activeItem==this.props.numPages}),items=this.props.items.map(function(item){return React.DOM.li({key:item,className:self.props.activeItem==item?"active":""},React.DOM.a({href:"#",onClick:self.props.handleClick.bind(null,item)},item))});return React.DOM.ul({className:"pagination pull-right"},React.DOM.li({className:prevClass},React.DOM.a({href:"#",onClick:this.props.handleClick.bind(null,this.props.activeItem-1)},"«")),items,React.DOM.li({className:nextClass},React.DOM.a({href:"#",onClick:this.props.handleClick.bind(null,this.props.activeItem+1)},"»")))}});